<!DOCTYPE html>
<html>
<head>
    <title>Simple WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Simple WebSocket Connection Test</h1>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        const token = '927e3890630dd9786c995bfde756a27468b6c4c6ae25a4011e364c158207cb9c';

        // Get room from URL or create new one
        const urlParams = new URLSearchParams(window.location.search);
        let roomName = urlParams.get('room') || 'test-room-' + Math.random().toString(36).substring(7);

        // Update URL if new room
        if (!urlParams.get('room')) {
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('room', roomName);
            window.history.pushState({}, '', newUrl.toString());
        }

        // Display shareable link
        const shareLink = window.location.href;
        log(`ðŸ”— Share this link to join the same room: ${shareLink}`, 'info');
        log(`Room: ${roomName}`, 'info');

        const url = `wss://signaling.gdsjam.com?token=${token}`;

        log(`Connecting to: ${url}`, 'info');

        const ws = new WebSocket(url);

        // Generate random client ID
        const clientId = 'client-' + Math.random().toString(36).substring(7);
        let messageCount = 0;

        ws.onopen = () => {
            log('âœ… WebSocket CONNECTED!', 'success');

            // Send subscribe message
            const subscribeMsg = {
                type: 'subscribe',
                topics: [roomName]
            };
            log(`ðŸ“¤ Subscribing to room: ${roomName}`, 'info');
            ws.send(JSON.stringify(subscribeMsg));

            // Send periodic messages
            setInterval(() => {
                messageCount++;
                const publishMsg = {
                    type: 'publish',
                    topic: roomName,
                    from: clientId,
                    message: `Hello from ${clientId} (message #${messageCount})`,
                    timestamp: Date.now()
                };
                log(`ðŸ“¤ Sending: ${publishMsg.message}`, 'info');
                ws.send(JSON.stringify(publishMsg));
            }, 3000);
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.from && data.from !== clientId) {
                log(`ðŸ“¥ Received from ${data.from}: ${data.message}`, 'success');
            } else if (data.from === clientId) {
                log(`ðŸ“¥ Echo from server: ${data.message} (clients: ${data.clients || '?'})`, 'info');
            } else {
                log(`ðŸ“¥ Received: ${event.data}`, 'success');
            }
        };

        ws.onerror = (error) => {
            log(`âŒ WebSocket ERROR: ${error}`, 'error');
            console.error('Full error:', error);
        };

        ws.onclose = (event) => {
            log(`Connection closed. Code: ${event.code}, Reason: ${event.reason || 'none'}`, 'info');
        };
    </script>
</body>
</html>

